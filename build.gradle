plugins {
    id 'application'
    // id 'ch.fhnw.thga.frege' version '1.0.0-alpha'
    // added by intellij frege plugin :
        id "idea"
        id "de.undercouch.download" version "4.1.1"

}

// repositories {
//     mavenCentral()
// }
//
// dependencies {
//     implementation files(compileFrege.fregeCompilerJar)
//
// }
//
// application {
//     mainClass = 'ch.fhnw.thga.datascience.HelloWorld'
// }
//
// java {
//     toolchain {
//         languageVersion = JavaLanguageVersion.of(16)
//     }
// }
//
// frege {
//     version = '3.25.84'
//     release = '3.25alpha'
//     mainSourceDir = layout.projectDirectory.dir('src/main/frege')
// }
//
// tasks.register('copyCompiledFregeClasses', Copy) {
//     from compileFrege.fregeOutputDir
//     include '**/*.java'
//     into layout.projectDirectory.dir('src/main/java')
//     mustRunAfter compileFrege
// }
//
// compileJava.configure {
//     options.encoding = 'UTF-8'
//     dependsOn compileFrege, copyCompiledFregeClasses
// }
//

// ----------------------- added from build.gradle as generated by the idea frege plugin -------------------------

ext {
    DEFAULT_JAVA_TARGET = "16"
    DEFAULT_FREGE_RELEASE = "3.25alpha"
    DEFAULT_FREGE_VERSION = "3.25.84"

    javaTarget = project.findProperty("javaTarget") ?: DEFAULT_JAVA_TARGET
    fregeRelease = project.findProperty("fregeRelease") ?: DEFAULT_FREGE_RELEASE
    fregeVersion = project.findProperty("fregeVersion") ?: DEFAULT_FREGE_VERSION

    fregeDoDownloadCompiler = !project.hasProperty("fregeJar")

    if (fregeDoDownloadCompiler) {
        fregeDir = "${rootProject.projectDir}/lib/org/frege-lang/frege/${fregeVersion}"
        fregeJar = "${fregeDir}/frege-${fregeVersion}.jar"
        fregeCompilerUrl = "https://github.com/Frege/frege/releases/download/${fregeRelease}/frege${fregeVersion}.jar"
        fregeLibDependency = "org.frege-lang:frege:${fregeVersion}"
        doDownloadCompiler()
    } else {
        fregeJarFile = file(project.getProperty("fregeJar"))
        fregeDir = fregeJarFile.getParentFile().toString()

        // get filename without extension, and add empty group before it
        fregeLibDependency = ":" + fregeJarFile.getName().take(fregeJarFile.getName().lastIndexOf("."))
    }

    fregeMainSourceDir = "${projectDir}/src/main/frege"
    fregeMainJavaDir   = "${buildDir}/src/main/frege"
}

idea {
    module {
        sourceDirs += file(fregeMainSourceDir)
    }
}

repositories {
    flatDir {
        dirs fregeDir
//        dir  "./lib"
    }
    mavenCentral()
    mavenLocal()
//    maven { // for the snapshots -- only if you need FregeFX
//   		url = "https://oss.sonatype.org/content/groups/public"
//   	}
}

void doDownloadCompiler() {
    download {
        src fregeCompilerUrl
        dest fregeJar
        overwrite false
    }
}

dependencies {
    // see https://github.com/HanSolo/charts use branch jdk16
//    implementation 'eu.hansolo.fx:charts:16.0.16'
    // see https://github.com/Frege/frege
    implementation fregeLibDependency
    // see https://github.com/Frege/FregeFX
    implementation 'org.frege-lang:fregefx:0.8.2-SNAPSHOT', { // only if you need FregeFX (and a Java with JavaFX 8)
        exclude module: 'frege'				   // fregefx comes with a frege dependency but we
     }

}

task fregeInit {
    group "frege"
    ant.mkdir(dir: fregeMainSourceDir)
}

task prepareCompileDirs { // prepare all the directories that the frege tasks rely upon
    group "frege"
    outputs.dir(sourceSets.main.java.outputDir).withPropertyName("compileOutputDir")
    outputs.dir(sourceSets.test.java.outputDir).withPropertyName("testOutputDir")
    doLast {
        ant.mkdir(dir: sourceSets.main.java.outputDir)
        ant.mkdir(dir: sourceSets.test.java.outputDir)
    }
}

task fregeCompile(type: JavaExec) {      	// https://docs.gradle.org/6.5/dsl/org.gradle.api.tasks.JavaExec.html
    dependsOn     prepareCompileDirs
    group       = "frege"
    description = "Compile the -Pfrege_file=."
    classpath   = files fregeJar
    args([
            "-d", sourceSets.main.java.outputDir,
            "-fp", sourceSets.main.compileClasspath.asPath,
            "-enc", "UTF-8",
            "-target", javaTarget,
            "-hints",
            "-make",
            "-sp", sourceSets.main.java.srcDirs.join(':'),
            "-ascii",
            "-latin",
            project.hasProperty("frege_file") ? project.frege_file : fregeMainSourceDir
    ])
}

fregeCompile.doLast {
    ant.move(toDir: fregeMainJavaDir) {
        fileSet(dir: sourceSets.main.java.outputDir) {
            include name:"**/*.java"
        }
    }
}

task fregeRun(type: JavaExec) {
    dependsOn     fregeCompile  // in case we always want to compile before running
    group         = "frege"
    description   = "Run -Pclass_name=${project.mainClassName}"
    standardInput = System.in 								// this might run interactively, so we need stdin
    classpath     = files sourceSets.main.runtimeClasspath.asPath
    main          = project.hasProperty("class_name") ? project.class_name : project.mainClassName
}

compileJava.dependsOn fregeCompile
sourceSets.main.compileClasspath = files (sourceSets.main.compileClasspath + sourceSets.main.java.outputDir)

repositories {
    mavenCentral()
}

dependencies {
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.7.0'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.7.0'
}

test {
    useJUnitPlatform()
}
